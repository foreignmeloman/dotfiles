plugins:
  # TMUX
  tmux-shell:
    shortCut: x
    description: "tmux horizontal split shell"
    scopes:
    - po
    command: tmux
    background: false
    args:
    - split-window
    - -v
    - bash
    - -c
    - >-
      kubectl --context=$CONTEXT --namespace=$NAMESPACE exec -it $NAME -- /bin/bash 2> /dev/null ||
      kubectl --context=$CONTEXT --namespace=$NAMESPACE exec -it $NAME -- /bin/sh 2> /dev/null ||
      kubectl --context=$CONTEXT --namespace=$NAMESPACE exec -it $NAME -- /bin/ash
  tmux-shell-container:
    shortCut: x
    description: "tmux horizontal split shell"
    scopes:
    - containers
    command: tmux
    background: false
    args:
    - split-window
    - -v
    - bash
    - -c
    - >-
      kubectl --context=$CONTEXT --namespace=$NAMESPACE exec -it --container=$NAME $POD -- /bin/bash 2> /dev/null ||
      kubectl --context=$CONTEXT --namespace=$NAMESPACE exec -it --container=$NAME $POD -- /bin/sh 2> /dev/null ||
      kubectl --context=$CONTEXT --namespace=$NAMESPACE exec -it --container=$NAME $POD -- /bin/ash
  helm-history:
    shortCut: h
    description: "Helm history"
    scopes:
    - helm
    command: bash
    background: false
    args:
    - -c
    - helm --kube-context=$CONTEXT --namespace=$NAMESPACE history $NAME | less -S --tilde +g
  external-secret-view:
    shortCut: x
    description: "View external secret data decoded"
    scopes:
    - externalsecrets
    command:  bash
    background: false
    args:
    - -c
    - |
      SECRET_NAME=$(kubectl --context=$CONTEXT --namespace=$NAMESPACE get externalsecrets $NAME -o jsonpath='{.spec.target.name}')
      [[ -z "$SECRET_NAME" ]] && SECRET_NAME="$NAME"
      {
        echo "ExternalSecret: $NAME"
        echo "Target Secret: $SECRET_NAME"
        echo "Namespace: $NAMESPACE"
        echo "Context: $CONTEXT"
        echo "---"
        kubectl --context=$CONTEXT --namespace=$NAMESPACE get secret "$SECRET_NAME" -o json | \
          yq eval '.data | to_entries | .[] | .key + ": " + (.value | @base64d)' -P
      } | less -S --tilde +g
  # ESO
  external-secret-refresh:
    shortCut: r
    description: "Annotate external secret to be refreshed immediately"
    scopes:
    - externalsecrets
    command: bash
    background: true
    confirm: true
    args:
    - -c
    - kubectl --context=$CONTEXT --namespace=$NAMESPACE annotate $RESOURCE_NAME $NAME force-sync=$(date +%s) --overwrite
  cluster-external-secret-refresh:
    shortCut: r
    description: "Annotate cluster external secret to be refreshed immediately"
    scopes:
    - clusterexternalsecrets
    command: bash
    background: true
    confirm: true
    args:
    - -c
    - kubectl --context=$CONTEXT annotate $RESOURCE_NAME $NAME external-secrets.io/force-sync=$(date +%s) --overwrite
  # LOGS
  gonzo:
    shortCut: Ctrl-L
    description: "Gonzo log analysis"
    scopes:
      - po
    command: sh
    background: false
    args:
      - -c
      - "kubectl logs -f --tail=0 $NAME -n $NAMESPACE --context $CONTEXT | gonzo"
  gonzo-container:
    shortCut: Ctrl-L
    description: "Gonzo log analysis"
    scopes:
      - containers
    command: sh
    background: false
    args:
      - -c
      - "kubectl logs -f --tail=0 --container=$NAME $POD -n $NAMESPACE --context $CONTEXT | gonzo"
  log-less:
    shortCut: Shift-L
    description: "logs|less"
    scopes:
    - po
    command: bash
    background: false
    args:
    - -c
    - '"$@" | less -S'
    - dummy-arg
    - kubectl
    - logs
    - $NAME
    - -n
    - $NAMESPACE
    - --context
    - $CONTEXT
    - --kubeconfig
    - $KUBECONFIG
  log-less-previous:
    shortCut: Shift-P
    description: "logs|less"
    scopes:
    - po
    command: bash
    background: false
    args:
    - -c
    - '"$@" | less -S'
    - dummy-arg
    - kubectl
    - logs
    - --previous
    - $NAME
    - -n
    - $NAMESPACE
    - --context
    - $CONTEXT
    - --kubeconfig
    - $KUBECONFIG
  log-less-container:
    shortCut: Shift-L
    description: "logs|less"
    scopes:
    - containers
    command: bash
    background: false
    args:
    - -c
    - '"$@" | less -S'
    - dummy-arg
    - kubectl
    - logs
    - -c
    - $NAME
    - $POD
    - -n
    - $NAMESPACE
    - --context
    - $CONTEXT
    - --kubeconfig
    - $KUBECONFIG
  log-less-container-previous:
    shortCut: Shift-P
    description: "logs|less"
    scopes:
    - containers
    command: bash
    background: false
    args:
    - -c
    - '"$@" | less -S'
    - dummy-arg
    - kubectl
    - logs
    - --previous
    - -c
    - $NAME
    - $POD
    - -n
    - $NAMESPACE
    - --context
    - $CONTEXT
    - --kubeconfig
    - $KUBECONFIG
  log-bat:
    shortCut: b
    description: "logs|bat"
    scopes:
    - po
    command: bash
    background: false
    args:
    - -c
    - '"$@" | bat -l=log'
    - dummy-arg
    - kubectl
    - logs
    - $NAME
    - -n
    - $NAMESPACE
    - --context
    - $CONTEXT
    - --kubeconfig
    - $KUBECONFIG
  log-bat-container:
    shortCut: b
    description: "logs|bat"
    scopes:
    - containers
    command: bash
    background: false
    args:
    - -c
    - '"$@" | bat -l=log'
    - dummy-arg
    - kubectl
    - logs
    - -c
    - $NAME
    - $POD
    - -n
    - $NAMESPACE
    - --context
    - $CONTEXT
    - --kubeconfig
    - $KUBECONFIG
  # FLUX
  flux-toggle-helmrelease:
    shortCut: Shift-T
    confirm: true
    scopes:
      - helmreleases
    description: Toggle to suspend or resume a HelmRelease
    command: bash
    background: true
    args:
    - -c
    - |
      SUSPENDED=$(kubectl --context $CONTEXT get helmreleases -n $NAMESPACE $NAME -o jsonpath='{.spec.suspend}')
      if [ "$SUSPENDED" = "true" ]; then
        kubectl --context $CONTEXT patch helmrelease -n $NAMESPACE $NAME --type=merge -p '{"spec":{"suspend":false}}'
      else
        kubectl --context $CONTEXT patch helmrelease -n $NAMESPACE $NAME --type=merge -p '{"spec":{"suspend":true}}'
      fi
  flux-tmux-log-helmrelease:
    shortCut: l
    scopes:
    - helmreleases
    description: Log HelmRelease events
    command: tmux
    background: false
    args:
    - split-window
    - -v
    - bash
    - -c
    - kubectl --context $CONTEXT events --namespace $NAMESPACE --for helmrelease/$NAME -w
  flux-toggle-kustomization:
    shortCut: Shift-T
    confirm: true
    scopes:
      - kustomizations
    description: Toggle to suspend or resume a Kustomization
    command: bash
    background: true
    args:
    - -c
    - |
      SUSPENDED=$(kubectl --context $CONTEXT get kustomizations -n $NAMESPACE $NAME -o jsonpath='{.spec.suspend}')
      if [ "$SUSPENDED" = "true" ]; then
        kubectl --context $CONTEXT patch kustomization -n $NAMESPACE $NAME --type=merge -p '{"spec":{"suspend":false}}'
      else
        kubectl --context $CONTEXT patch kustomization -n $NAMESPACE $NAME --type=merge -p '{"spec":{"suspend":true}}'
      fi
  flux-tmux-log-kustomization:
    shortCut: l
    scopes:
    - kustomizations
    description: Log Kustomization events
    command: tmux
    background: false
    args:
    - split-window
    - -v
    - bash
    - -c
    - kubectl --context $CONTEXT events --namespace $NAMESPACE --for kustomization/$NAME -w
  flux-reconcile-git:
    shortCut: Shift-R
    confirm: true
    description: Flux reconcile
    scopes:
    - gitrepositories
    command: bash
    background: true
    args:
    - -c
    - kubectl --context=$CONTEXT --namespace=$NAMESPACE annotate gitrepositories $NAME reconcile.fluxcd.io/requestedAt="$(date -u +%Y-%m-%dT%H:%M:%SZ)" --overwrite
  flux-reconcile-hr:
    shortCut: Shift-R
    confirm: true
    description: Flux reconcile
    scopes:
    - helmreleases
    command: bash
    background: true
    args:
    - -c
    - kubectl --context=$CONTEXT --namespace=$NAMESPACE annotate helmreleases $NAME reconcile.fluxcd.io/requestedAt="$(date -u +%Y-%m-%dT%H:%M:%SZ)" --overwrite
  flux-reconcile-hr-force:
    shortCut: Shift-F
    confirm: true
    description: Flux reconcile (force upgrade)
    scopes:
    - helmreleases
    command: bash
    background: true
    args:
    - -c
    - >
      TOKEN="$(date +%s)";
      kubectl --context=$CONTEXT --namespace=$NAMESPACE annotate --overwrite helmreleases $NAME "reconcile.fluxcd.io/requestedAt=$TOKEN" "reconcile.fluxcd.io/forceAt=$TOKEN"
  flux-reconcile-ks:
    shortCut: Shift-R
    confirm: true
    description: Flux reconcile
    scopes:
    - kustomizations
    command: bash
    background: true
    args:
    - -c
    - kubectl --context=$CONTEXT --namespace=$NAMESPACE annotate kustomizations $NAME reconcile.fluxcd.io/requestedAt="$(date -u +%Y-%m-%dT%H:%M:%SZ)" --overwrite
  flux-reconcile-ir:
    shortCut: Shift-R
    confirm: true
    description: Flux reconcile
    scopes:
      - imagerepositories
    command: bash
    background: true
    args:
    - -c
    - kubectl --context=$CONTEXT --namespace=$NAMESPACE annotate imagerepositories $NAME reconcile.fluxcd.io/requestedAt="$(date -u +%Y-%m-%dT%H:%M:%SZ)" --overwrite
  flux-reconcile-iua:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
      - imageupdateautomations
    command: sh
    background: false
    args:
    - -c
    - kubectl --context=$CONTEXT --namespace=$NAMESPACE annotate imageupdateautomations $NAME reconcile.fluxcd.io/requestedAt="$(date -u +%Y-%m-%dT%H:%M:%SZ)" --overwrite
