plugins:
  # TMUX
  tmux-shell:
    shortCut: x
    description: "tmux horizontal split shell"
    scopes:
    - po
    command: tmux
    background: false
    args:
    - split-window
    - -v
    - bash
    - -c
    - >-
      kubectl --context=$CONTEXT --namespace=$NAMESPACE exec -it $NAME -- /bin/sh 2> /dev/null ||
      kubectl --context=$CONTEXT --namespace=$NAMESPACE exec -it $NAME -- /bin/bash 2> /dev/null ||
      kubectl --context=$CONTEXT --namespace=$NAMESPACE exec -it $NAME -- /bin/ash
  tmux-shell-container:
    shortCut: x
    description: "tmux horizontal split shell"
    scopes:
    - containers
    command: tmux
    background: false
    args:
    - split-window
    - -v
    - bash
    - -c
    - >-
      kubectl --context=$CONTEXT --namespace=$NAMESPACE exec -it --container=$NAME $POD -- /bin/sh 2> /dev/null ||
      kubectl --context=$CONTEXT --namespace=$NAMESPACE exec -it --container=$NAME $POD -- /bin/bash 2> /dev/null ||
      kubectl --context=$CONTEXT --namespace=$NAMESPACE exec -it --container=$NAME $POD -- /bin/ash
  # ESO
  external-secret-refresh:
    shortCut: r
    description: "Annotate extenal secret to be refreshed immideately"
    scopes:
    - externalsecrets
    command: bash
    background: true
    confirm: true
    args:
    - -c
    - kubectl --context=$CONTEXT --namespace=$NAMESPACE annotate $RESOURCE_NAME $NAME force-sync=$(date +%s) --overwrite
  cluster-external-secret-refresh:
    shortCut: r
    description: "Annotate cluster extenal secret to be refreshed immideately"
    scopes:
    - clusterexternalsecrets
    command: bash
    background: true
    confirm: true
    args:
    - -c
    - kubectl --context=$CONTEXT annotate $RESOURCE_NAME $NAME external-secrets.io/force-sync=$(date +%s) --overwrite
  # LOGS
  gonzo:
    shortCut: Ctrl-L
    description: "Gonzo log analysis"
    scopes:
      - po
    command: sh
    background: false
    args:
      - -c
      - "kubectl logs -f --tail=0 $NAME -n $NAMESPACE --context $CONTEXT | gonzo"
  gonzo-container:
    shortCut: Ctrl-L
    description: "Gonzo log analysis"
    scopes:
      - containers
    command: sh
    background: false
    args:
      - -c
      - "kubectl logs -f --tail=0 --container=$NAME $POD -n $NAMESPACE --context $CONTEXT | gonzo"
  log-less:
    shortCut: Shift-L
    description: "logs|less"
    scopes:
    - po
    command: bash
    background: false
    args:
    - -c
    - '"$@" | less'
    - dummy-arg
    - kubectl
    - logs
    - $NAME
    - -n
    - $NAMESPACE
    - --context
    - $CONTEXT
    - --kubeconfig
    - $KUBECONFIG
  log-less-container:
    shortCut: Shift-L
    description: "logs|less"
    scopes:
    - containers
    command: bash
    background: false
    args:
    - -c
    - '"$@" | less'
    - dummy-arg
    - kubectl
    - logs
    - -c
    - $NAME
    - $POD
    - -n
    - $NAMESPACE
    - --context
    - $CONTEXT
    - --kubeconfig
    - $KUBECONFIG
  log-bat:
    shortCut: b
    description: "logs|bat"
    scopes:
    - po
    command: bash
    background: false
    args:
    - -c
    - '"$@" | bat -l=log'
    - dummy-arg
    - kubectl
    - logs
    - $NAME
    - -n
    - $NAMESPACE
    - --context
    - $CONTEXT
    - --kubeconfig
    - $KUBECONFIG
  log-bat-container:
    shortCut: b
    description: "logs|bat"
    scopes:
    - containers
    command: bash
    background: false
    args:
    - -c
    - '"$@" | bat -l=log'
    - dummy-arg
    - kubectl
    - logs
    - -c
    - $NAME
    - $POD
    - -n
    - $NAMESPACE
    - --context
    - $CONTEXT
    - --kubeconfig
    - $KUBECONFIG
  # FLUX
  flux-toggle-helmrelease:
    shortCut: Shift-T
    confirm: true
    scopes:
      - helmreleases
    description: Toggle to suspend or resume a HelmRelease
    command: sh
    background: false
    args:
      - -c
      - "flux --context $CONTEXT $([ $(kubectl --context $CONTEXT get helmreleases -n $NAMESPACE $NAME -o=custom-columns=TYPE:.spec.suspend | tail -1) = \"true\" ] && echo \"resume\" || echo \"suspend\") helmrelease -n $NAMESPACE $NAME | less"
  flux-toggle-kustomization:
    shortCut: Shift-T
    confirm: true
    scopes:
      - kustomizations
    description: Toggle to suspend or resume a Kustomization
    command: sh
    background: false
    args:
      - -c
      - "flux --context $CONTEXT $([ $(kubectl --context $CONTEXT get kustomizations -n $NAMESPACE $NAME -o=custom-columns=TYPE:.spec.suspend | tail -1) = \"true\" ] && echo \"resume\" || echo \"suspend\") kustomization -n $NAMESPACE $NAME | less"
  flux-reconcile-git:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
    - gitrepositories
    command: sh
    background: false
    args:
    - -c
    - "flux --context $CONTEXT reconcile source git -n $NAMESPACE $NAME | less"
  flux-reconcile-hr:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
    - helmreleases
    command: sh
    background: false
    args:
    - -c
    - "flux --context $CONTEXT reconcile helmrelease -n $NAMESPACE $NAME | less"
  flux-reconcile-ks:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
    - kustomizations
    command: sh
    background: false
    args:
    - -c
    - "flux --context $CONTEXT reconcile kustomization -n $NAMESPACE $NAME | less"
  flux-reconcile-ir:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
      - imagerepositories
    command: sh
    background: false
    args:
      - -c
      - flux --context $CONTEXT reconcile image repository -n $NAMESPACE $NAME | less
  flux-reconcile-iua:
    shortCut: Shift-R
    confirm: false
    description: Flux reconcile
    scopes:
      - imageupdateautomations
    command: sh
    background: false
    args:
      - -c
      - flux --context $CONTEXT reconcile image update -n $NAMESPACE $NAME | less
  flux-trace:
    shortCut: Ctrl-T
    confirm: false
    description: Flux trace
    scopes:
    - all
    command: sh
    background: false
    args:
    - -c
    - "flux --context $CONTEXT trace $NAME --kind `echo $RESOURCE_NAME | sed -E 's/(s|es)$//g'` --api-version $RESOURCE_GROUP/$RESOURCE_VERSION --namespace $NAMESPACE $NAME | less"
